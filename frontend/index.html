<!DOCTYPE html>
<html>
<head>
    <title>Supply Chain DApp - Volume Based</title>
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { border: 1px solid #ccc; padding: 20px; margin: 10px 0; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; cursor: pointer; border-radius: 3px; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
        .success { color: green; }
        .error { color: red; }
        .tab { display: none; }
        .active { display: block; }
        .info-box { background: #f0f8ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .inventory-item { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Supply Chain Management - Volume Based</h1>

    <div class="warning">
        <strong>Volume-Based Supply Chain</strong><br>
        All product transfers now require specifying volume amount!
    </div>

    <!-- Navigation -->
    <div style="margin-bottom: 20px;">
        <button onclick="showTab('registerTab')">Register</button>
        <button onclick="showTab('loginTab')">Login</button>
        <button onclick="showTab('appTab')" id="appTabBtn" style="display: none;">App</button>
    </div>

    <!-- Registration Tab -->
    <div id="registerTab" class="tab active">
        <div class="section">
            <h2>Register New User</h2>
            <input type="text" id="regUsername" placeholder="Choose your username (e.g., john_doe, acme_corp)">
            <input type="password" id="regPassword" placeholder="Set password (for local security)">
            <input type="text" id="regName" placeholder="Your full name or company name">
            <select id="regRole">
                <option value="0">Manufacturer</option>
                <option value="1">Supplier</option>
                <option value="2">Vendor</option>
                <option value="3">Customer</option>
            </select>
            
            <button onclick="registerUser()">Register User</button>
            <div id="regResult"></div>
        </div>
    </div>

    <!-- Login Tab -->
    <div id="loginTab" class="tab">
        <div class="section">
            <h2>Login with Username</h2>
            <input type="text" id="loginUsername" placeholder="Your username">
            <input type="password" id="loginPassword" placeholder="Your password">
            <button onclick="loginUser()">Login</button>
            <div id="loginResult"></div>
        </div>
    </div>

    <!-- Application Tab -->
    <div id="appTab" class="tab">
        <div class="section">
            <h2>Logged in as: <span id="userWelcome"></span></h2>
            <p><strong>Username:</strong> <span id="displayUsername"></span></p>
            <p><strong>Wallet Address:</strong> <span id="userAddress"></span></p>
            <p><strong>Role:</strong> <span id="userRole"></span></p>
            <button onclick="logout()" style="background: #dc3545;">Logout</button>
        </div>

        <!-- My Inventory Section -->
        <div class="section">
            <h3>My Inventory</h3>
            <button onclick="loadMyInventory()">Refresh My Inventory</button>
            <button onclick="loadMyInventoryWithDetails()">Show Detailed Inventory</button>
            <div id="myInventory"></div>
        </div>

        <!-- User Inventory Lookup Section -->
        <div class="section">
            <h3>Lookup User Inventory</h3>
            <input type="text" id="inventoryUsername" placeholder="Enter username to check their inventory">
            <button onclick="lookupUserInventory()">Check Inventory</button>
            <button onclick="lookupUserInventoryWithDetails()">Check Detailed Inventory</button>
            <div id="userInventoryResult"></div>
        </div>

        <!-- Register Product Section -->
        <div class="section">
            <h3>Register Product</h3>
            <input type="text" id="productName" placeholder="Product name">
            <input type="text" id="manufacturerName" placeholder="Manufacturer name">
            <input type="text" id="barcode" placeholder="Barcode">
            <input type="text" id="manufacturedTime" placeholder="Manufactured time (YYYY-MM-DD)">
            <input type="number" id="productVolume" placeholder="Product volume" min="1">
            <button onclick="registerProduct()">Register Product</button>
            <div id="productResult"></div>
        </div>

        <!-- Transfer Product Section -->
        <div class="section">
            <h3>Transfer Product</h3>
            <input type="text" id="transferBarcode" placeholder="Product barcode">
            <input type="text" id="buyerUsername" placeholder="Buyer's username">
            <input type="number" id="transferVolume" placeholder="Volume to transfer" min="1">
            <button onclick="transferProductByUsername()">Transfer Product</button>
            <div id="transferResult"></div>
            
            <!-- Transfer status information -->
            <div id="transferStatus" style="margin-top: 10px;"></div>
        </div>

        <!-- Lookup Product Section -->
        <div class="section">
            <h3>Lookup Product</h3>
            <input type="text" id="lookupBarcode" placeholder="Enter barcode">
            <button onclick="lookupProduct()">Lookup Product</button>
            <div id="productInfo"></div>
        </div>

        <!-- Lookup User Section -->
        <div class="section">
            <h3>Lookup User by Username</h3>
            <input type="text" id="lookupUsername" placeholder="Enter username">
            <button onclick="lookupUser()">Lookup User</button>
            <div id="userInfo"></div>
        </div>

        <!-- Check Transfer Permission Section -->
        <div class="section">
            <h3>Check Transfer Permission</h3>
            <input type="text" id="checkSeller" placeholder="Seller username (optional)" value="">
            <input type="text" id="checkBuyer" placeholder="Buyer username">
            <button onclick="checkTransferPermission()">Check Permission</button>
            <div id="permissionResult"></div>
        </div>
    </div>

    <script>
        // Contract configuration - UPDATED ABI with volume parameters
        const CONTRACT_ADDRESS = "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0";
        const CONTRACT_ABI = [
            "function registerUser(string name, uint8 role, string publicKey) public",
            // UPDATED: Added volume parameter
            "function registerProduct(string name, string manufacturerName, string barcode, string manufacturedTime, uint256 volume) external",
            // UPDATED: Added volume parameter
            "function sellProduct(address buyer, string barcode, uint256 volume) external",
            // UPDATED: Added volume parameter
            "function sellProductByPublicKey(string buyerPublicKey, string barcode, uint256 volume) external",
            "function getUserByPublicKey(string publicKey) external view returns (tuple(address userAddress, string name, uint8 role, string publicKey))",
            // UPDATED: Product struct now includes volume
            "function getProductByBarcode(string barcode) public view returns (tuple(string name, string manufacturerName, string barcode, string manufacturedTime, uint256 volume))",
            "function returnUser(address addr) external view returns (tuple(address userAddress, string name, uint8 role, string publicKey))",
            "function isSaleAllowedByPublicKey(string sellerPublicKey, string buyerPublicKey) external view returns (bool)",
            // UPDATED: Inventory functions now return products with volume
            "function getUserInventory(address user) external view returns (string[] memory)",
            "function getUserInventoryWithDetails(address user) external view returns (tuple(string name, string manufacturerName, string barcode, string manufacturedTime, uint256 volume)[] memory)",
            "function getUserInventoryByPublicKey(string publicKey) external view returns (string[] memory)",
            "function getUserInventoryWithDetailsByPublicKey(string publicKey) external view returns (tuple(string name, string manufacturerName, string barcode, string manufacturedTime, uint256 volume)[] memory)",
            "function getProductByBarcode(string barcode) public view returns (tuple(string name, string manufacturerName, string barcode, string manufacturedTime, uint256 volume))",
            // NEW: Volume functions
            "function getUserTotalVolume(address user) external view returns (uint256)",
            "function getUserTotalVolumeByPublicKey(string publicKey) external view returns (uint256)"
        ];

        let provider, wallet, contract, currentUser;

        // Pre-funded Hardhat accounts for registration
        const fundedPrivateKeys = [
            "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80",
            "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d",
            "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a"
        ];

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        // Register user with custom username
        async function registerUser() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value.trim();
            const role = document.getElementById('regRole').value;

            if (!username) {
                alert("Please choose a username!");
                return;
            }
            if (!password) {
                alert("Please set a password!");
                return;
            }
            if (!name) {
                alert("Please enter your name!");
                return;
            }
            if (username.length < 3) {
                alert("Username must be at least 3 characters long!");
                return;
            }

            try {
                document.getElementById('regResult').innerHTML = "Creating your account...";

                provider = new ethers.providers.JsonRpcProvider("http://localhost:8545");
                
                const userWallet = ethers.Wallet.createRandom().connect(provider);
                
                const randomIndex = Math.floor(Math.random() * fundedPrivateKeys.length);
                const fundedWallet = new ethers.Wallet(fundedPrivateKeys[randomIndex], provider);
                
                document.getElementById('regResult').innerHTML = "Funding your wallet...";
                const fundTx = await fundedWallet.sendTransaction({
                    to: userWallet.address,
                    value: ethers.utils.parseEther("0.01")
                });
                await fundTx.wait();

                const userContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, userWallet);
                
                document.getElementById('regResult').innerHTML = "Registering on blockchain...";
                const tx = await userContract.registerUser(name, role, username);
                await tx.wait();

                const userData = {
                    address: userWallet.address,
                    privateKey: userWallet.privateKey,
                    username: username,
                    name: name,
                    role: role
                };

                localStorage.setItem('user_' + username, btoa(JSON.stringify(userData)));
                localStorage.setItem('password_' + username, btoa(password));

                document.getElementById('regResult').innerHTML = 
                    '<span class="success">Registration successful! You can now login.</span>';

                document.getElementById('regUsername').value = '';
                document.getElementById('regPassword').value = '';
                document.getElementById('regName').value = '';

            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = error.message;
                
                if (errorMessage.includes("Public key already registered")) {
                    errorMessage = "Username already taken! Please choose a different username.";
                } else if (errorMessage.includes("user rejected transaction")) {
                    errorMessage = "Transaction was rejected.";
                } else if (errorMessage.includes("insufficient funds")) {
                    errorMessage = "Insufficient funds for gas.";
                }
                
                document.getElementById('regResult').innerHTML = 
                    '<span class="error">Registration failed: ' + errorMessage + '</span>';
            }
        }

        async function loginUser() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                alert("Please enter username and password");
                return;
            }

            try {
                document.getElementById('loginResult').innerHTML = "Logging in...";

                const storedUserData = localStorage.getItem('user_' + username);
                const storedPassword = localStorage.getItem('password_' + username);

                if (!storedUserData || !storedPassword) {
                    throw new Error("User not found. Please register first.");
                }

                if (btoa(password) !== storedPassword) {
                    throw new Error("Invalid password");
                }

                const userData = JSON.parse(atob(storedUserData));

                provider = new ethers.providers.JsonRpcProvider("http://localhost:8545");
                wallet = new ethers.Wallet(userData.privateKey, provider);
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, wallet);

                const blockchainUser = await contract.getUserByPublicKey(username);
                
                if (blockchainUser.userAddress === "0x0000000000000000000000000000000000000000") {
                    throw new Error("User not found on blockchain");
                }

                currentUser = {
                    ...userData,
                    blockchainData: blockchainUser
                };

                document.getElementById('userWelcome').textContent = userData.name;
                document.getElementById('displayUsername').textContent = username;
                document.getElementById('userAddress').textContent = wallet.address;
                document.getElementById('userRole').textContent = getRoleName(userData.role);
                
                document.getElementById('checkSeller').value = username;
                
                document.getElementById('loginResult').innerHTML = 
                    '<span class="success">Login successful!</span>';
                
                document.getElementById('appTabBtn').style.display = 'inline-block';
                showTab('appTab');

                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';

                loadMyInventory();

            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginResult').innerHTML = 
                    '<span class="error">Login failed: ' + error.message + '</span>';
            }
        }

        // Load current user's inventory
        async function loadMyInventory() {
            if (!contract || !currentUser) {
                alert("Please login first!");
                return;
            }

            try {
                document.getElementById('myInventory').innerHTML = "Loading your inventory...";
                
                const inventory = await contract.getUserInventory(wallet.address);
                
                if (inventory.length === 0) {
                    document.getElementById('myInventory').innerHTML = 
                        '<div class="info-box">Your inventory is empty. Register some products to get started!</div>';
                    return;
                }

                let html = `<h4>Your Products (${inventory.length} items):</h4>`;
                html += '<div class="inventory-grid">';
                
                for (let i = 0; i < inventory.length; i++) {
                    html += `
                        <div class="inventory-item">
                            <strong>Barcode:</strong> ${inventory[i]}<br>
                            <button onclick="lookupProductByBarcode('${inventory[i]}')">View Details</button>
                        </div>
                    `;
                }
                
                html += '</div>';
                document.getElementById('myInventory').innerHTML = html;

            } catch (error) {
                console.error('Inventory load error:', error);
                document.getElementById('myInventory').innerHTML = 
                    '<span class="error">Failed to load inventory: ' + error.message + '</span>';
            }
        }

        // Load current user's inventory with details
        async function loadMyInventoryWithDetails() {
            if (!contract || !currentUser) {
                alert("Please login first!");
                return;
            }

            try {
                document.getElementById('myInventory').innerHTML = "Loading detailed inventory...";
                
                const inventoryDetails = await contract.getUserInventoryWithDetails(wallet.address);
                
                if (inventoryDetails.length === 0) {
                    document.getElementById('myInventory').innerHTML = 
                        '<div class="info-box">Your inventory is empty. Register some products to get started!</div>';
                    return;
                }

                let html = `<h4>Your Detailed Inventory (${inventoryDetails.length} items):</h4>`;
                html += '<div class="inventory-grid">';
                
                for (let i = 0; i < inventoryDetails.length; i++) {
                    const product = inventoryDetails[i];
                    html += `
                        <div class="inventory-item">
                            <strong>${product.name}</strong><br>
                            <strong>Barcode:</strong> ${product.barcode}<br>
                            <strong>Manufacturer:</strong> ${product.manufacturerName}<br>
                            <strong>Manufactured:</strong> ${product.manufacturedTime}<br>
                            <strong>Volume:</strong> ${product.volume}<br>
                            <button onclick="lookupProductByBarcode('${product.barcode}')">Full Details</button>
                        </div>
                    `;
                }
                
                html += '</div>';
                document.getElementById('myInventory').innerHTML = html;

            } catch (error) {
                console.error('Detailed inventory load error:', error);
                document.getElementById('myInventory').innerHTML = 
                    '<span class="error">Failed to load detailed inventory: ' + error.message + '</span>';
            }
        }

        // Lookup user inventory by username
        async function lookupUserInventory() {
            if (!contract) {
                alert("Please login first!");
                return;
            }

            const username = document.getElementById('inventoryUsername').value.trim();
            
            if (!username) {
                alert("Please enter a username");
                return;
            }

            try {
                document.getElementById('userInventoryResult').innerHTML = `Loading inventory for ${username}...`;
                
                const inventory = await contract.getUserInventoryByPublicKey(username);
                
                if (inventory.length === 0) {
                    document.getElementById('userInventoryResult').innerHTML = 
                        `<div class="info-box">${username}'s inventory is empty.</div>`;
                    return;
                }

                let html = `<h4>${username}'s Inventory (${inventory.length} items):</h4>`;
                html += '<div class="inventory-grid">';
                
                for (let i = 0; i < inventory.length; i++) {
                    html += `
                        <div class="inventory-item">
                            <strong>Barcode:</strong> ${inventory[i]}<br>
                            <button onclick="lookupProductByBarcode('${inventory[i]}')">View Details</button>
                        </div>
                    `;
                }
                
                html += '</div>';
                document.getElementById('userInventoryResult').innerHTML = html;

            } catch (error) {
                console.error('User inventory lookup error:', error);
                document.getElementById('userInventoryResult').innerHTML = 
                    '<span class="error">Failed to load user inventory: ' + error.message + '</span>';
            }
        }

        // Lookup user inventory with details by username
        async function lookupUserInventoryWithDetails() {
            if (!contract) {
                alert("Please login first!");
                return;
            }

            const username = document.getElementById('inventoryUsername').value.trim();
            
            if (!username) {
                alert("Please enter a username");
                return;
            }

            try {
                document.getElementById('userInventoryResult').innerHTML = `Loading detailed inventory for ${username}...`;
                
                const inventoryDetails = await contract.getUserInventoryWithDetailsByPublicKey(username);
                
                if (inventoryDetails.length === 0) {
                    document.getElementById('userInventoryResult').innerHTML = 
                        `<div class="info-box">${username}'s inventory is empty.</div>`;
                    return;
                }

                let html = `<h4>${username}'s Detailed Inventory (${inventoryDetails.length} items):</h4>`;
                html += '<div class="inventory-grid">';
                
                for (let i = 0; i < inventoryDetails.length; i++) {
                    const product = inventoryDetails[i];
                    html += `
                        <div class="inventory-item">
                            <strong>${product.name}</strong><br>
                            <strong>Barcode:</strong> ${product.barcode}<br>
                            <strong>Manufacturer:</strong> ${product.manufacturerName}<br>
                            <strong>Manufactured:</strong> ${product.manufacturedTime}<br>
                            <strong>Volume:</strong> ${product.volume}<br>
                            <button onclick="lookupProductByBarcode('${product.barcode}')">Full Details</button>
                        </div>
                    `;
                }
                
                html += '</div>';
                document.getElementById('userInventoryResult').innerHTML = html;

            } catch (error) {
                console.error('User detailed inventory lookup error:', error);
                document.getElementById('userInventoryResult').innerHTML = 
                    '<span class="error">Failed to load user detailed inventory: ' + error.message + '</span>';
            }
        }

        // Helper function: Lookup product by barcode and display in product info section
        async function lookupProductByBarcode(barcode) {
            if (!contract) {
                alert("Please login first!");
                return;
            }

            try {
                document.getElementById('productInfo').innerHTML = `Loading product ${barcode}...`;
                
                const product = await contract.getProductByBarcode(barcode);
                document.getElementById('productInfo').innerHTML = `
                    <h4>Product Details:</h4>
                    <div class="info-box">
                        <p><strong>Name:</strong> ${product.name}</p>
                        <p><strong>Manufacturer:</strong> ${product.manufacturerName}</p>
                        <p><strong>Barcode:</strong> ${product.barcode}</p>
                        <p><strong>Manufactured:</strong> ${product.manufacturedTime}</p>
                        <p><strong>Volume:</strong> ${product.volume}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('productInfo').innerHTML = 
                    '<span class="error">Product not found: ' + barcode + '</span>';
            }
        }

        // Transfer product using buyer's username with volume
        async function transferProductByUsername() {
            if (!contract) {
                alert("Please login first!");
                return;
            }

            const barcode = document.getElementById('transferBarcode').value.trim();
            const buyerUsername = document.getElementById('buyerUsername').value.trim();
            const volume = document.getElementById('transferVolume').value;

            if (!barcode || !buyerUsername || !volume) {
                alert("Please enter product barcode, buyer username, and volume");
                return;
            }

            try {
                document.getElementById('transferResult').innerHTML = "Preparing transfer...";
                document.getElementById('transferStatus').innerHTML = "Checking buyer...";

                // First, verify the buyer exists
                const buyerUser = await contract.getUserByPublicKey(buyerUsername);
                document.getElementById('transferStatus').innerHTML = 
                    `Buyer found: ${buyerUser.name} (${getRoleName(buyerUser.role)})`;

                // Check if transfer is allowed
                document.getElementById('transferStatus').innerHTML += "<br>Checking transfer permissions...";
                const isAllowed = await contract.isSaleAllowedByPublicKey(currentUser.username, buyerUsername);
                
                if (!isAllowed) {
                    throw new Error(`Transfer not allowed: ${getRoleName(currentUser.role)} cannot sell to ${getRoleName(buyerUser.role)}`);
                }

                document.getElementById('transferStatus').innerHTML += "<br>Transfer allowed!";

                // Execute the transfer using username with volume
                document.getElementById('transferStatus').innerHTML += "<br>Executing transfer...";
                const tx = await contract.sellProductByPublicKey(buyerUsername, barcode, volume);
                await tx.wait();

                document.getElementById('transferResult').innerHTML = 
                    '<span class="success">Product transferred successfully to ' + buyerUsername + '!</span>';
                document.getElementById('transferStatus').innerHTML += "<br>Transfer completed!";
                
                // Clear form
                document.getElementById('transferBarcode').value = '';
                document.getElementById('buyerUsername').value = '';
                document.getElementById('transferVolume').value = '';

                // Refresh inventory after transfer
                loadMyInventory();

            } catch (error) {
                console.error('Transfer error:', error);
                document.getElementById('transferResult').innerHTML = 
                    '<span class="error">Transfer failed: ' + error.message + '</span>';
                document.getElementById('transferStatus').innerHTML = '';
            }
        }

        // Check transfer permission between users
        async function checkTransferPermission() {
            const sellerUsername = document.getElementById('checkSeller').value.trim() || currentUser.username;
            const buyerUsername = document.getElementById('checkBuyer').value.trim();

            if (!buyerUsername) {
                alert("Please enter a buyer username");
                return;
            }

            try {
                document.getElementById('permissionResult').innerHTML = "Checking...";

                const isAllowed = await contract.isSaleAllowedByPublicKey(sellerUsername, buyerUsername);
                
                // Get user details for display
                const sellerUser = await contract.getUserByPublicKey(sellerUsername);
                const buyerUser = await contract.getUserByPublicKey(buyerUsername);

                if (isAllowed) {
                    document.getElementById('permissionResult').innerHTML = `
                        <span class="success">
                            Transfer ALLOWED<br>
                            <strong>${sellerUser.name}</strong> (${getRoleName(sellerUser.role)}) → 
                            <strong>${buyerUser.name}</strong> (${getRoleName(buyerUser.role)})
                        </span>
                    `;
                } else {
                    document.getElementById('permissionResult').innerHTML = `
                        <span class="error">
                            Transfer NOT ALLOWED<br>
                            <strong>${sellerUser.name}</strong> (${getRoleName(sellerUser.role)}) cannot sell to 
                            <strong>${buyerUser.name}</strong> (${getRoleName(buyerUser.role)})<br>
                            <small>Supply chain path: Manufacturer → Supplier → Vendor → Customer</small>
                        </span>
                    `;
                }

            } catch (error) {
                document.getElementById('permissionResult').innerHTML = 
                    '<span class="error">Error: ' + error.message + '</span>';
            }
        }

        // Product registration with volume
        async function registerProduct() {
            if (!contract) {
                alert("Please login first!");
                return;
            }

            const name = document.getElementById('productName').value;
            const manufacturerName = document.getElementById('manufacturerName').value;
            const barcode = document.getElementById('barcode').value;
            const manufacturedTime = document.getElementById('manufacturedTime').value;
            const volume = document.getElementById('productVolume').value;

            if (!volume || volume < 1) {
                alert("Please enter a valid volume (minimum 1)");
                return;
            }

            try {
                const tx = await contract.registerProduct(name, manufacturerName, barcode, manufacturedTime, volume);
                await tx.wait();
                document.getElementById('productResult').innerHTML = 
                    '<span class="success">Product registered successfully!</span>';
                
                // Clear form
                document.getElementById('productName').value = '';
                document.getElementById('manufacturerName').value = '';
                document.getElementById('barcode').value = '';
                document.getElementById('manufacturedTime').value = '';
                document.getElementById('productVolume').value = '';

                // Refresh inventory after registering new product
                loadMyInventory();

            } catch (error) {
                document.getElementById('productResult').innerHTML = 
                    '<span class="error">Error: ' + error.message + '</span>';
            }
        }

        // Product lookup
        async function lookupProduct() {
            if (!contract) {
                alert("Please login first!");
                return;
            }

            const barcode = document.getElementById('lookupBarcode').value;

            try {
                const product = await contract.getProductByBarcode(barcode);
                document.getElementById('productInfo').innerHTML = `
                    <h4>Product Details:</h4>
                    <div class="info-box">
                        <p><strong>Name:</strong> ${product.name}</p>
                        <p><strong>Manufacturer:</strong> ${product.manufacturerName}</p>
                        <p><strong>Barcode:</strong> ${product.barcode}</p>
                        <p><strong>Manufactured:</strong> ${product.manufacturedTime}</p>
                        <p><strong>Volume:</strong> ${product.volume}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('productInfo').innerHTML = 
                    '<span class="error">Product not found</span>';
            }
        }

        // User lookup by username
        async function lookupUser() {
            if (!contract) {
                alert("Please login first!");
                return;
            }

            const username = document.getElementById('lookupUsername').value.trim();

            if (!username) {
                alert("Please enter a username");
                return;
            }

            try {
                const user = await contract.getUserByPublicKey(username);
                document.getElementById('userInfo').innerHTML = `
                    <h4>User Details:</h4>
                    <div class="info-box">
                        <p><strong>Username:</strong> ${user.publicKey}</p>
                        <p><strong>Name:</strong> ${user.name}</p>
                        <p><strong>Address:</strong> ${user.userAddress}</p>
                        <p><strong>Role:</strong> ${getRoleName(user.role)}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('userInfo').innerHTML = 
                    '<span class="error">User not found</span>';
            }
        }

        // Helper function to get role name
        function getRoleName(roleValue) {
            const roles = ['Manufacturer', 'Supplier', 'Vendor', 'Customer'];
            return roles[roleValue] || 'Unknown';
        }

        // Logout
        function logout() {
            wallet = null;
            contract = null;
            currentUser = null;
            document.getElementById('appTabBtn').style.display = 'none';
            showTab('loginTab');
        }

        ////////////////////////////////////////////////////////////////////////////////////
        const OBSERVER_URL = "http://localhost:3001";

        async function queryObserver() {
            try {
                // Get all users from observer
                const usersResponse = await fetch(`${OBSERVER_URL}/api/users`);
                const users = await usersResponse.json();
                console.log('All registered users:', users);

                // Get product history
                const historyResponse = await fetch(`${OBSERVER_URL}/api/products/123456789/history`);
                const history = await historyResponse.json();
                console.log('Product history:', history);

                // Get user inventory from observer
                if (wallet && wallet.address) {
                    const inventoryResponse = await fetch(`${OBSERVER_URL}/api/users/${wallet.address}/inventory`);
                    const inventory = await inventoryResponse.json();
                    console.log('My inventory from observer:', inventory);
                }
            } catch (error) {
                console.error('Error querying observer:', error);
            }
        }

        // Call this function after login
        async function loadObserverData() {
            await queryObserver();
        }
        ////////////////////////////////////////////////////////////////////////////////////

        // Initialize
        window.onload = function() {
            console.log("Supply Chain DApp loaded - Volume Based Version");
        };
    </script>
</body>
</html>